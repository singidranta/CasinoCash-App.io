import{T as Q}from"./vendor-4QxL1Nz2.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const i of o)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(o){const i={};return o.integrity&&(i.integrity=o.integrity),o.referrerPolicy&&(i.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?i.credentials="include":o.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function a(o){if(o.ep)return;o.ep=!0;const i=n(o);fetch(o.href,i)}})();const F={balances:{gcoin:0,real_balance:0},storageKey:"app_wallet",init(){try{const e=localStorage.getItem(this.storageKey);e?this.balances=JSON.parse(e):(this.balances.gcoin=1e3,this.balances.real_balance=5,this.save())}catch(e){console.error("Failed to load wallet from storage",e)}this.updateDisplay()},getBalance(e="gcoin"){return this.balances[e]},updateBalance(e,t){Object.prototype.hasOwnProperty.call(this.balances,e)?(this.balances[e]=t,this.save(),this.updateDisplay()):console.error(`Currency ${e} not found.`)},add(e,t="gcoin"){Object.prototype.hasOwnProperty.call(this.balances,t)&&(this.balances[t]+=e,this.save(),this.updateDisplay())},subtract(e,t="gcoin"){return Object.prototype.hasOwnProperty.call(this.balances,t)&&this.balances[t]>=e?(this.balances[t]-=e,this.save(),this.updateDisplay(),!0):!1},save(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.balances))}catch(e){console.error("Failed to save wallet to storage",e)}},updateDisplay(){const e=document.getElementById("gcoin-balance");if(e)try{e.textContent=this.balances.gcoin.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}catch{e.textContent=String(this.balances.gcoin)}const t=document.getElementById("real-balance-amount");if(t)try{t.textContent=this.balances.real_balance.toLocaleString("en-US",{style:"currency",currency:"USD"})}catch{t.textContent=`$${Number(this.balances.real_balance).toFixed(2)}`}const n=document.getElementById("game-balance-amount");if(n)try{n.textContent=this.balances.gcoin.toLocaleString("en-US")}catch{n.textContent=String(this.balances.gcoin)}}},le={storageKey:"gcoin_settings",config:{sound:!0,backgroundAnimation:!0,soundVolume:45},init(){try{const e=localStorage.getItem(this.storageKey);e&&(this.config=JSON.parse(e))}catch(e){console.error("Failed to load settings from storage",e)}this.applyToUI(),this.listenForChanges()},save(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.config)),console.log("Settings saved:",this.config)}catch(e){console.error("Failed to save settings to storage",e)}},applyToUI(){const e=document.getElementById("sound-toggle"),t=document.getElementById("bg-animation-toggle"),n=document.getElementById("sound-volume");e&&(e.checked=this.config.sound),t&&(t.checked=this.config.backgroundAnimation),n&&(n.value=this.config.soundVolume)},listenForChanges(){const e=document.getElementById("sound-toggle"),t=document.getElementById("bg-animation-toggle"),n=document.getElementById("sound-volume");e&&e.addEventListener("change",a=>{this.config.sound=a.target.checked,this.save()}),t&&t.addEventListener("change",a=>{this.config.backgroundAnimation=a.target.checked,this.save()}),n&&n.addEventListener("input",a=>{this.config.soundVolume=Number(a.target.value),this.save()})}},_={lottery:{key:"lottery",name:"Lottery Game",description:"Оплатите билет и получите шанс 20% сорвать джекпот х5.",type:"lottery",minBet:10,maxBet:250,defaultBet:25,winChance:.2,winMultiplier:5},coinflip:{key:"coinflip",name:"Coin Flip",description:"Выберите сторону и удвойте ставку при верном угадывании.",type:"coinflip",minBet:10,maxBet:300,defaultBet:20,options:["Орёл","Решка"]},crash:{key:"crash",name:"Crash",description:"Следите за ракетой и выводите до взрыва. Настройте автостоп.",type:"crash",minBet:5,maxBet:500,defaultBet:30,multipliers:[1.5,2,3,5],maxAutoStop:10}};function R(e,t){const n=_[e];if(!n)return 0;const a=Number.isFinite(t)?t:n.defaultBet;return Math.min(Math.max(a,n.minBet),n.maxBet)}function de(e){return _[e]||null}function J(e,t){const n=_[e];if(!n)return!1;const a=R(e,t??n.defaultBet);return F.getBalance("gcoin")>=a}function H(e,t){const n=R(e,t);if(!F.subtract(n,"gcoin"))throw new Error("Недостаточно gcoin для ставки");return n}function V(e){e>0&&F.add(e,"gcoin")}function ue(e){const t=_.lottery,n=R("lottery",e),a=Math.random()<t.winChance,o=a?n*t.winMultiplier:0;return V(o),{win:a,bet:n,reward:o,multiplier:t.winMultiplier,message:a?`Джекпот! Выигрыш ${o.toFixed(2)} gcoin.`:"Не повезло в этот раз. Попробуйте снова!"}}function me(e,t){const n=R("coinflip",t),a=Math.random()<.5?"Орёл":"Решка",o=e===a,i=o?n*2:0;return V(i),{win:o,bet:n,reward:i,result:a,message:o?`Вы угадали! Баланс пополнен на ${i.toFixed(2)} gcoin.`:`Выпало "${a}". Ставка проиграна.`}}function ge({autoStopMultiplier:e=2,volatility:t=3.2}){const n=1+Math.random()*t,a=[];let o=1;for(;o<n&&(o+=Math.random()*.28+.05,a.push(Number(o.toFixed(2))),!(a.length>100)););const i=e<n;return{crashPoint:Number(n.toFixed(2)),path:a,survived:i}}function fe(e,t){const n=R("crash",e),a=Math.max(1.1,t),{crashPoint:o,path:i,survived:c}=ge({autoStopMultiplier:a});let r=0;return c&&(r=Number((n*a).toFixed(2)),V(r)),{win:c,bet:n,reward:r,crashPoint:o,autoStop:a,path:i,message:c?`Ракета достигла x${a.toFixed(2)} до взрыва! Профит ${r.toFixed(2)} gcoin.`:`Краш на x${o.toFixed(2)}. Вы не успели вывести.`}}function pe(e){const t="lottery",n=e.info;let a=n.defaultBet,o=null,i=[],c=null,r=!1;const s=()=>{c&&(clearInterval(c),c=null)},d=p=>{a=Number(p),Number.isFinite(a)||(a=n.defaultBet),a=Math.min(Math.max(a,n.minBet),n.maxBet),e.setStakeInfo(a)},y=()=>{const p=document.createElement("div");p.className="game-control-group";const b=document.createElement("label");b.textContent="Размер ставки";const I=document.createElement("input");I.type="range",I.min=String(n.minBet),I.max=String(n.maxBet),I.step="1",I.value=String(a),I.className="stake-slider";const v=document.createElement("input");return v.type="number",v.min=String(n.minBet),v.max=String(n.maxBet),v.step="1",v.value=String(a),v.className="stake-input",I.addEventListener("input",u=>{v.value=u.target.value,d(u.target.value)}),v.addEventListener("change",u=>{const l=Number(u.target.value);d(l),I.value=String(a),v.value=String(a)}),p.appendChild(b),p.appendChild(I),p.appendChild(v),p},A=()=>{const p=document.createElement("div");p.className="lottery-stage";const b=document.createElement("div");return b.className="lottery-grid",i=Array.from({length:9}).map((I,v)=>{const u=document.createElement("div");return u.className="lottery-card",u.innerHTML=`<span class="lottery-number">#${v+1}</span>`,b.appendChild(u),u}),p.appendChild(b),p},w=()=>{i.forEach(p=>{p.classList.remove("active","winner","loser")})},x=(p,b)=>{let I=0,v=0;const u=16+Math.floor(Math.random()*6);s(),c=setInterval(()=>{if(i.forEach(l=>l.classList.remove("active")),i[I%i.length].classList.add("active"),I+=1,v+=1,v>=u){s();const l=i[p];w(),l.classList.add(b.win?"winner":"loser"),e.setStatus(b.message,b.win?"win":"lose"),r=!1,o&&(o.disabled=!1,o.textContent="Купить билет")}},90)},B=()=>{if(r)return;if(!J(t,a)){e.setStatus("Недостаточно gcoin для покупки билета.","lose");return}const p=H(t,a),b=ue(p);w(),e.setStatus("Выбор счастливого билета...",""),r=!0,o&&(o.disabled=!0,o.textContent="Розыгрыш...");const I=Math.floor(Math.random()*i.length);x(I,b)},S=()=>{const p=document.createElement("div");return p.className="game-controls-row",o=document.createElement("button"),o.type="button",o.className="btn btn-primary",o.textContent="Купить билет",o.addEventListener("click",B),p.appendChild(o),p},N=()=>{e.configEl.appendChild(y()),e.stageEl.appendChild(A()),e.controlsEl.appendChild(S()),e.setStatus("Настройте ставку и купите билет.",""),e.setMultiplierInfo(1,!1)},h=()=>{s(),i=[],o=null,r=!1};return d(a),{mount:N,destroy:h}}function he(e){var v;const t="coinflip",n=e.info;let a=n.defaultBet,o=((v=n.options)==null?void 0:v[0])||"Орёл",i=!1,c=null,r=null,s=null;const d=()=>{c&&(clearTimeout(c),c=null)},y=u=>{a=Number(u),Number.isFinite(a)||(a=n.defaultBet),a=Math.min(Math.max(a,n.minBet),n.maxBet),e.setStakeInfo(a)},A=u=>{o=u,e.setStatus(`Вы выбрали ${u}.`,"")},w=u=>u==="Решка"?"tails":"heads",x=()=>{const u=document.createElement("div");u.className="game-control-group";const l=document.createElement("label");l.textContent="Размер ставки";const m=document.createElement("input");m.type="range",m.min=String(n.minBet),m.max=String(n.maxBet),m.step="1",m.value=String(a),m.className="stake-slider";const g=document.createElement("input");return g.type="number",g.min=String(n.minBet),g.max=String(n.maxBet),g.step="1",g.value=String(a),g.className="stake-input",m.addEventListener("input",f=>{g.value=f.target.value,y(f.target.value)}),g.addEventListener("change",f=>{const E=Number(f.target.value);y(E),m.value=String(a),g.value=String(a)}),u.appendChild(l),u.appendChild(m),u.appendChild(g),u},B=()=>{var g;const u=document.createElement("div");u.className="game-control-group";const l=document.createElement("label");l.textContent="Сторона монеты",u.appendChild(l);const m=document.createElement("div");return m.className="coin-choice-row",(g=n.options)==null||g.forEach(f=>{const E=document.createElement("button");E.type="button",E.className="btn btn-secondary btn-choice",E.textContent=f,f===o&&E.classList.add("active"),E.addEventListener("click",()=>{m.querySelectorAll(".btn-choice").forEach(T=>T.classList.remove("active")),E.classList.add("active"),A(f)}),m.appendChild(E)}),u.appendChild(m),u},S=()=>{const u=document.createElement("div");u.className="coin-stage";const l=document.createElement("div");l.className="coin",l.dataset.side=w(o);const m=document.createElement("div");m.className="coin-face coin-front",m.textContent="Орёл";const g=document.createElement("div");return g.className="coin-face coin-back",g.textContent="Решка",l.appendChild(m),l.appendChild(g),u.appendChild(l),r=l,u},N=(u,l)=>{if(!r)return;r.classList.remove("coin-win","coin-lose"),r.classList.add("coin-flip");const m=l.win;c=setTimeout(()=>{r.classList.remove("coin-flip"),r.style.transform=u==="Решка"?"rotateY(180deg)":"rotateY(0deg)",r.dataset.side=w(u),r.classList.add(m?"coin-win":"coin-lose"),e.setStatus(l.message,m?"win":"lose"),i=!1,s&&(s.disabled=!1,s.textContent="Бросить монету")},1500)},h=()=>{if(i)return;if(!J(t,a)){e.setStatus("Недостаточно gcoin для ставки.","lose");return}const u=H(t,a),l=me(o,u);e.setStatus("Монета в полёте...",""),i=!0,s&&(s.disabled=!0,s.textContent="Бросаем..."),d(),N(l.result,l)},p=()=>{const u=document.createElement("div");return u.className="game-controls-row",s=document.createElement("button"),s.type="button",s.className="btn btn-primary",s.textContent="Бросить монету",s.addEventListener("click",h),u.appendChild(s),u},b=()=>{e.configEl.appendChild(x()),e.configEl.appendChild(B()),e.stageEl.appendChild(S()),e.controlsEl.appendChild(p()),e.setStatus("Выберите сторону и сделайте ставку.",""),e.setMultiplierInfo(1,!1)},I=()=>{d(),r=null,s=null,i=!1};return y(a),A(o),{mount:b,destroy:I}}function ye(e){var u;const t="crash",n=e.info;let a=n.defaultBet,o=((u=n.multipliers)==null?void 0:u[1])||2,i=!1,c=null,r=null,s=null,d=null,y=null;const A=l=>{a=Number(l),Number.isFinite(a)||(a=n.defaultBet),a=Math.min(Math.max(a,n.minBet),n.maxBet),e.setStakeInfo(a)},w=l=>{var m;o=Number(l),Number.isFinite(o)||(o=((m=n.multipliers)==null?void 0:m[0])||1.5),o=Math.min(Math.max(o,1.1),n.maxAutoStop||10),e.setMultiplierInfo(o,!0)},x=()=>{const l=document.createElement("div");l.className="game-control-group";const m=document.createElement("label");m.textContent="Размер ставки";const g=document.createElement("input");g.type="range",g.min=String(n.minBet),g.max=String(n.maxBet),g.step="1",g.value=String(a),g.className="stake-slider";const f=document.createElement("input");return f.type="number",f.min=String(n.minBet),f.max=String(n.maxBet),f.step="1",f.value=String(a),f.className="stake-input",g.addEventListener("input",E=>{f.value=E.target.value,A(E.target.value)}),f.addEventListener("change",E=>{const T=Number(E.target.value);A(T),g.value=String(a),f.value=String(a)}),l.appendChild(m),l.appendChild(g),l.appendChild(f),l},B=()=>{const l=document.createElement("div");l.className="game-control-group";const m=document.createElement("label");m.textContent="Автостоп (множитель)";const g=document.createElement("input");g.type="range",g.min="1.1",g.max=String(n.maxAutoStop||10),g.step="0.1",g.value=String(o),g.className="stake-slider";const f=document.createElement("input");return f.type="number",f.min="1.1",f.max=String(n.maxAutoStop||10),f.step="0.1",f.value=String(o),f.className="stake-input",g.addEventListener("input",E=>{f.value=E.target.value,w(E.target.value)}),f.addEventListener("change",E=>{const T=Number(E.target.value);w(T),g.value=String(o),f.value=String(o)}),l.appendChild(m),l.appendChild(g),l.appendChild(f),l},S=()=>{const l=document.createElement("div");l.className="crash-stage";const m=document.createElement("canvas");return m.width=360,m.height=200,m.className="crash-canvas",l.appendChild(m),r=m,s=m.getContext("2d"),N(),l},N=()=>{!s||!r||(s.clearRect(0,0,r.width,r.height),s.fillStyle="rgba(18, 16, 42, 0.75)",s.fillRect(0,0,r.width,r.height),s.strokeStyle="rgba(125, 120, 255, 0.28)",s.lineWidth=1,s.setLineDash([4,6]),s.beginPath(),s.moveTo(0,r.height-40),s.lineTo(r.width,40),s.stroke(),s.setLineDash([]),s.fillStyle="rgba(143, 150, 199, 0.8)",s.font="12px Manrope",s.fillText("x1",6,r.height-10),s.fillText("x2",80,r.height-80),s.fillText("x5",160,r.height-140),s.fillText("x10",r.width-36,60))},h=(l,m,g)=>{if(!s||!r)return;cancelAnimationFrame(c),N(),s.strokeStyle=g?"rgba(95, 255, 211, 0.85)":"rgba(255, 92, 154, 0.85)",s.lineWidth=3,s.beginPath();const f=Math.max(m,o,...l,1.5),E=(r.height-40)/Math.max(f,1.2),T=(r.width-40)/l.length;l.forEach((ce,q)=>{const z=20+T*q,X=r.height-ce*E;q===0?s.moveTo(z,X):s.lineTo(z,X)}),s.stroke(),s.fillStyle=g?"rgba(95, 255, 211, 0.9)":"rgba(255, 92, 154, 0.9)",s.beginPath();const se=l[l.length-1]||1,ie=20+T*(l.length-1),re=r.height-se*E;s.arc(ie,re,6,0,Math.PI*2),s.fill(),s.fillStyle="rgba(143, 150, 199, 0.85)",s.font="13px Manrope",s.textAlign="right",s.fillText(`Краш: x${m.toFixed(2)}`,r.width-12,24),s.fillText(`Автостоп: x${o.toFixed(2)}`,r.width-12,42),s.textAlign="left"},p=()=>{if(i)return;if(!J(t,a)){e.setStatus("Недостаточно gcoin для ставки.","lose");return}const l=H(t,a);i=!0,e.setStatus("Ракета взлетает...",""),d&&(d.disabled=!0),y&&(y.disabled=!0);const m=fe(l,o);e.setStatus(m.message,m.win?"win":"lose"),N();let g=0;const f=()=>{const E=m.path.slice(0,Math.min(g,m.path.length));h(E,m.crashPoint,m.win),g+=1,g<=m.path.length?c=requestAnimationFrame(f):(i=!1,d&&(d.disabled=!1),y&&(y.disabled=!1))};c=requestAnimationFrame(f)},b=()=>{const l=document.createElement("div");return l.className="game-controls-row",d=document.createElement("button"),d.type="button",d.className="btn btn-primary",d.textContent="Старт",d.addEventListener("click",p),y=document.createElement("button"),y.type="button",y.className="btn btn-secondary",y.textContent="Очистить график",y.addEventListener("click",()=>{N(),e.setStatus("График очищен. Настройте автостоп и ставку.","")}),l.appendChild(d),l.appendChild(y),l},I=()=>{e.configEl.appendChild(x()),e.configEl.appendChild(B()),e.stageEl.appendChild(S()),e.controlsEl.appendChild(b()),e.setStatus("Настройте ставку и автостоп, затем запускайте раунд.","")},v=()=>{cancelAnimationFrame(c),c=null,r=null,s=null,d=null,y=null,i=!1};return A(a),w(o),{mount:I,destroy:v}}const be={lottery:pe,coinflip:he,crash:ye};function we({titleEl:e,descriptionEl:t,configEl:n,stageEl:a,controlsEl:o,statusEl:i,stakeInfoEl:c,multiplierInfoEl:r}){const s={activeKey:null,activeInstance:null},d=h=>{h&&(h.innerHTML="")},y=(h="",p="")=>{i&&(i.textContent=h,i.classList.remove("game-result-win","game-result-lose"),p==="win"?i.classList.add("game-result-win"):p==="lose"&&i.classList.add("game-result-lose"))},A=h=>{c&&(typeof h=="number"?c.textContent=`Ставка: ${h.toFixed(2)} gcoin`:c.textContent=h||"Ставка: —")},w=(h,p=!0)=>{if(r){if(!p){r.style.display="none";return}r.style.display="",r.textContent=`Множитель: x${Number(h||1).toFixed(2)}`}},x=()=>{if(y("Выберите игру, чтобы начать раунд.",""),A("Ставка: —"),w(1,!1),d(n),d(a),d(o),a){const h=document.createElement("div");h.className="game-placeholder",h.textContent="Выберите игру из главного зала",a.appendChild(h)}},B=()=>{s.activeInstance&&typeof s.activeInstance.destroy=="function"&&s.activeInstance.destroy(),s.activeInstance=null,s.activeKey=null},S=h=>{var u;const p=be[h],b=de(h);if(!p||!b){console.warn("[GameManager] Unknown game key:",h);return}if(B(),d(n),d(a),d(o),y("Настройте параметры и нажмите старт.",""),typeof b.defaultBet=="number"?A(b.defaultBet):typeof b.minBet=="number"?A(b.minBet):A("Ставка: —"),b.type==="crash"){const l=((u=b.multipliers)==null?void 0:u[0])||1.5;w(l,!0)}else w(1,!1);e&&(e.textContent=b.name),t&&(t.textContent=b.description);const v=p({configEl:n,stageEl:a,controlsEl:o,setStatus:y,setStakeInfo:A,setMultiplierInfo:w,info:b});v&&typeof v.mount=="function"?(v.mount(),s.activeInstance=v,s.activeKey=h):(console.warn("[GameManager] Invalid game instance for key:",h),x())},N=()=>{B(),e&&(e.textContent="Выберите игру"),t&&(t.textContent="Откройте игру из каталога, чтобы начать."),x()};return N(),{openGame:S,reset:N,hasActiveGame:()=>!!s.activeKey,getActiveGameKey:()=>s.activeKey}}function ve(e){const t={home:document.getElementById("home-view"),game:document.getElementById("game-view"),wallet:document.getElementById("wallet-view")},n=document.querySelectorAll(".nav-item"),a=()=>{Object.values(t).forEach(c=>{c&&(c.style.display="none")})},o=c=>{n.forEach(r=>{r.classList.toggle("active",r.dataset.view===c)})},i=c=>{a();const r=t[c]||t.home;r&&(r.style.display="flex")};return n.forEach(c=>{const r=c.dataset.view||"home";c.addEventListener("click",s=>{s.preventDefault(),i(r),o(r),r==="home"&&e.reset()})}),i("home"),o("home"),{switchView:i,updateNavActive:o}}function Ee(){const e=document.getElementById("settings-modal"),t=document.querySelector(".settings-btn"),n=document.getElementById("close-settings-btn");t&&t.addEventListener("click",()=>{e&&(e.style.display="flex")}),n&&n.addEventListener("click",()=>{e&&(e.style.display="none")}),e&&e.addEventListener("click",a=>{a.target===e&&(e.style.display="none")})}function Ce(){return we({titleEl:document.getElementById("active-game-title"),descriptionEl:document.getElementById("active-game-description"),configEl:document.getElementById("game-config"),stageEl:document.getElementById("game-stage"),controlsEl:document.getElementById("game-controls"),statusEl:document.getElementById("game-status"),stakeInfoEl:document.getElementById("game-stake-info"),multiplierInfoEl:document.getElementById("game-multiplier-info")})}function xe(e,t){document.querySelectorAll(".game-card").forEach(a=>{a.addEventListener("click",()=>{const o=a.dataset.game;o&&(t.switchView("game"),t.updateNavActive("game"),e.openGame(o))})})}function Se(e,t){const n=document.getElementById("back-to-library");n&&n.addEventListener("click",()=>{e.reset(),t.switchView("home"),t.updateNavActive("home")})}function Ae(){const e=Ce(),t=ve(e);Ee(),xe(e,t),Se(e,t)}const C={adsgram:{blockId:"15234",sdkUrl:"https://sad.adsgram.ai/js/sad.min.js"},monetag:{scriptUrl:"https://libtl.com/sdk.js",showFunctionName:"show_9922551",defaultOptions:{type:"end",requestVar:"ad_reward_button",timeout:15e3,catchIfNoFeed:!0}},tonConnect:{manifestUrl:"https://singidranta.github.io/CasinoCash-App.io/tonconnect-manifest.json",buttonContainerId:"ton-connect-button",addressElementId:"ton-address",recipientAddress:"EQC-your-ton-address",purchase:{amount:"2",currency:"TON",description:"Gcoin top-up"}},rewards:{perAdUsd:.1},rotationKey:"ad_next_provider"},U=new Map;let O=null;function Be(){return typeof window<"u"&&window.Telegram&&window.Telegram.WebApp}function Ie(){return!String(C.monetag.scriptUrl).startsWith("REPLACE_")&&!0}function K(){return!String(C.adsgram.blockId).startsWith("REPLACE_")}function Ne(){const e=Number(localStorage.getItem("adsgram_disabled_until")||0);return Number.isFinite(e)?e:0}function W(){return Ne()>Date.now()}function Le(e,t=""){try{const n=Date.now()+Math.max(0,e);localStorage.setItem("adsgram_disabled_until",String(n)),console.warn("[AdsGram] Temporarily disabled until",new Date(n).toISOString(),t||"")}catch{}}function $(e){return new Promise((t,n)=>{if(!e||e.startsWith("REPLACE_WITH"))return n(new Error("Script URL is not configured"));if(U.has(e)){const c=U.get(e);if(c==="loaded")return t();if(c&&c.then)return c.then(t).catch(n)}const a=document.querySelector(`script[src="${e}"]`);if(a)return a.dataset.loaded="true",U.set(e,"loaded"),t();const o=document.createElement("script");o.src=e,o.async=!0,o.referrerPolicy="no-referrer-when-downgrade",o.addEventListener("load",()=>{o.dataset.loaded="true",U.set(e,"loaded"),t()}),o.addEventListener("error",()=>{U.delete(e),n(new Error(`Failed to load script ${e}`))}),document.head.appendChild(o);const i=new Promise((c,r)=>{o.addEventListener("load",()=>c()),o.addEventListener("error",()=>r(new Error(`Failed to load script ${e}`)))});U.set(e,i)})}async function ne(){if(!K())return console.warn("[AdsGram] blockId is not configured. Skipping init."),null;if(W())return console.warn("[AdsGram] temporarily disabled, skipping init"),null;try{!window.Telegram&&!document.querySelector('script[src="https://telegram.org/js/telegram-web-app.js"]')&&await $("https://telegram.org/js/telegram-web-app.js")}catch(e){console.warn("[AdsGram] Telegram SDK not loaded:",e.message)}if(window.Adsgram&&typeof window.Adsgram.init=="function"||await $(C.adsgram.sdkUrl),!window.Adsgram||typeof window.Adsgram.init!="function")return console.warn("[AdsGram] SDK not available after script load"),null;try{return O=window.Adsgram.init({blockId:C.adsgram.blockId}),O}catch(e){return console.warn("[AdsGram] init failed:",e.message),null}}async function Z(){try{if(O||await ne(),!O||!O.show)throw new Error("AdsGram controller not available");return{ok:!0,provider:"adsgram",payload:await O.show()}}catch(e){try{const t=String((e==null?void 0:e.message)||e||"").toLowerCase();(t.includes("not active")||t.includes("moderation"))&&Le(6*60*60*1e3,"block inactive/moderation")}catch{}return{ok:!1,provider:"adsgram",error:e}}}async function ee(){var e;try{if(!C.monetag.scriptUrl||C.monetag.scriptUrl.startsWith("REPLACE_"))throw new Error("Monetag script URL is not configured");await $(C.monetag.scriptUrl);const t=C.monetag.showFunctionName,n=t&&window[t];if(typeof n!="function")throw new Error(`Monetag show function ${t} is not available`);const a={...C.monetag.defaultOptions};if(Be())try{const i=(e=window.Telegram.WebApp.initDataUnsafe)==null?void 0:e.user;i&&i.id&&(a.ymid=String(i.id))}catch{}return{ok:!0,provider:"monetag",payload:await n(a)}}catch(t){return{ok:!1,provider:"monetag",error:t}}}function j(){const e=C.rotationKey,t=localStorage.getItem(e);return t==="monetag"||t==="adsgram"?t:(localStorage.setItem(e,"monetag"),"monetag")}function ke(){const e=C.rotationKey,n=j()==="monetag"?"adsgram":"monetag";return localStorage.setItem(e,n),n}const ae={async init(){K()&&!W()&&ne().catch(e=>console.warn("[AdsGram] preload failed:",e.message)),j()},async showRewardedAd(){var i,c,r;const e=[];if(Ie()&&e.push("monetag"),K()&&!W()&&e.push("adsgram"),e.length===0)return{ok:!1,error:{message:"No ad providers configured or available"}};const t=j();let n=e.includes(t)?t:e[0],a=e.find(s=>s!==n);ke();let o=n==="monetag"?await ee():await Z();if(o.ok)return o;if(a){let s=a==="monetag"?await ee():await Z();return s.ok?s:{ok:!1,error:{first:(i=o.error)==null?void 0:i.message,second:(c=s.error)==null?void 0:c.message}}}return{ok:!1,error:{first:(r=o.error)==null?void 0:r.message}}}},Me="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAABjUlEQVR4Xu3asUoDQRQG4S8QEASxElA7iMWAHuQIINsDGwnGwg2InECsBNbC92WaxOQJmIvhNdlbxczfZRrSybXfXn2njzzo+evfuygSADef2gH4AjP4jFzI/6sQngIFx8DWiwbK9wfSW0fHiv2CBzpAZUwLU2zWtEZwOxiNQYDixTBpxXEy3KMWOYp1w5yqMMdYOsmw0YpgGfUm2gKgmCae5wGPy3gV3NuMEJH0Gfe68AxVfwZLjwCAo8A0ePiGMB9JMJ34YAe6Fw/frgWBn8s0T4V0EYvw47CqdTm9i4vJZoU0rK5o5KZgpcr3PH90LwWWIlpO+kwLpN/jo4X4JKE7uTDMps68C8F3wOAy6PxF4FQ2b8GAp9nJF0OgUwRv9HiJwH9gTCXwKA/1DijwNXIMNHmAAPtm9+R0G4q6nM4CN5vP/0ID6s5P/BIB3O7YfGiDIe3O4B4DN6Y8nXgVgPyJ2dyylwB/Bsj0h/+P8DfgMj3juwJgO0nze8CsA2SeVufgVgD5J9P7ArANkn5bx4FYD8idncspcAfx6IzwFfkdDwAAAAASUVORK5CYII=";let P=null;function k(...e){console.info("[TonConnect]",...e)}function te(e,t){console.groupCollapsed(`[TonConnect] ${e}`);try{t()}finally{console.groupEnd()}}function M(...e){console.error("[TonConnect]",...e)}let L=null,G=null;const Te=new Set;function D(e){Y(e),Te.forEach(t=>{try{t(e||null)}catch(n){console.warn("[TonConnect] subscriber error",n)}});try{window.dispatchEvent(new CustomEvent("ton-status",{detail:e||null}))}catch{}}function Fe(e){const t=e,n=window.location.href.split("#")[0].split("?")[0],a=n.endsWith("/")?n:`${n.substring(0,n.lastIndexOf("/")+1)}`;try{const i=new URL(t,a).toString();return k("Resolved manifest URL:",i),i}catch(o){M("Manifest URL resolution failed relative to page. Falling back to origin root.",o);try{return new URL(t,window.location.origin+"/").toString()}catch(i){throw new Error(`TonConnect invalid manifest URL: ${i.message}`)}}}function Ue(){try{const{origin:e,pathname:t}=window.location,n=t.endsWith("/")?t:t.substring(0,t.lastIndexOf("/")+1);return`${e}${n}`}catch(e){return M("Failed to derive app base URL:",e),null}}function Oe(e,t){if(!e||typeof e!="object")return{manifest:null,changed:!1};const n={...e};let a=!1;const o=Ue();(!n.url||n.url===t)&&o&&(n.url=o,a=!0),n.name||(n.name=(C==null?void 0:C.appName)||document.title||"TonConnect App",a=!0);const i=typeof n.iconUrl=="string"?n.iconUrl:"";return(!i||i.endsWith(".svg")||i.startsWith("data:image/svg")||i.startsWith("http"))&&(n.iconUrl=Me,a=!0),{manifest:n,changed:a}}async function Re(e){try{te(`Manifest preflight → ${e}`,()=>{k("Initiating fetch with no-cache headers")});const t=await fetch(e,{method:"GET",cache:"no-store",mode:"cors"});if(!t.ok){const o=await t.text().catch(()=>"<<unreadable>>");throw new Error(`HTTP ${t.status}. Body preview: ${o.slice(0,180)}`)}const n=await t.clone().text().catch(()=>null),a=(()=>{try{return JSON.parse(n||"{}")}catch(o){return M("Manifest JSON parse failed:",o),null}})();return te("Manifest content preview",()=>{k("HTTP status:",t.status,t.statusText),a?k("Fields:",JSON.stringify(a,null,2)):k("Raw text:",n==null?void 0:n.slice(0,500))}),{manifestJson:a,manifestText:n}}catch(t){throw M("Manifest fetch failed:",t),t}}function Y(e){var n;const t=document.getElementById((n=C.tonConnect)==null?void 0:n.addressElementId);if(t)if(e!=null&&e.address){const a=`${e.address.slice(0,6)}...${e.address.slice(-4)}`;t.textContent=a,t.dataset.full=e.address,t.classList.add("connected")}else t.textContent="Not connected",t.dataset.full="",t.classList.remove("connected")}function Pe(){var t;const e=document.getElementById((t=C.tonConnect)==null?void 0:t.addressElementId);e&&(e.style.cursor="pointer",e.addEventListener("click",async()=>{const n=e.dataset.full||"";if(n)try{await navigator.clipboard.writeText(n);const a=e.textContent;e.textContent="Copied!",setTimeout(()=>Y((L==null?void 0:L.account)||null)||(e.textContent=a),1e3)}catch(a){console.warn("[TonConnect] clipboard copy failed",a)}}))}async function Ge(){var c,r,s;const e=(c=C.tonConnect)==null?void 0:c.buttonContainerId,t=Fe((r=C.tonConnect)==null?void 0:r.manifestUrl),n=await Re(t);let a=t;const{manifest:o,changed:i}=Oe((n==null?void 0:n.manifestJson)||null,t);i&&o&&(P&&URL.revokeObjectURL(P),P=URL.createObjectURL(new Blob([JSON.stringify(o)],{type:"application/json"})),a=P,k("Using sanitized manifest blob URL:",a));try{L=new Q({manifestUrl:a,buttonRootId:e,language:"ru"}),k("TonConnectUI instance created. Version:",((s=Q)==null?void 0:s.version)||"unknown")}catch(d){throw M("Failed to create TonConnectUI instance:",d,d==null?void 0:d.stack),d}Pe(),Y(L.account),L.onStatusChange(d=>{k("Status change → wallet",d?d.account:"null"),D(d)},d=>{M("Status change error:",d),D(null)});try{const d=await L.connectionRestored;k("connectionRestored resolved →",d),d&&D(L.account)}catch(d){M("Connection restoration failed:",d)}return L}function oe(){return G||(G=Ge().catch(e=>(M("init failed:",(e==null?void 0:e.message)||e),L=null,G=null,null))),G}function _e(){return L}async function De(){const e=await oe();return e||M("ensureTonConnectReady → TonConnectUI unavailable"),e}function Ke(){var e;L&&((e=L.openModal)==null||e.call(L))}function We(e){const t=Number(e);return!Number.isFinite(t)||t<=0?null:BigInt(Math.round(t*1e9)).toString()}async function $e(){var c,r,s,d,y,A,w,x,B;const e=_e()||await De();if(!e){alert("TonConnect UI не инициализирован. Проверьте manifestUrl.");return}if(!e.account){Ke(),alert("Подключите TON-кошелёк, чтобы продолжить.");return}const t=(c=C.tonConnect)==null?void 0:c.recipientAddress,n=We((s=(r=C.tonConnect)==null?void 0:r.purchase)==null?void 0:s.amount);if(!n){alert("Параметры TON-покупки не настроены.");return}const a={address:t,amount:n},o=(y=(d=C.tonConnect)==null?void 0:d.purchase)==null?void 0:y.payloadHex;o&&(a.payload=o);const i={validUntil:Math.round(Date.now()/1e3)+(((w=(A=C.tonConnect)==null?void 0:A.purchase)==null?void 0:w.ttl)||300),messages:[a]};try{await e.sendTransaction(i);const S=((B=(x=C.tonConnect)==null?void 0:x.purchase)==null?void 0:B.successMessage)||"Платёж в TON отправлен! После подтверждения пополните баланс вручную.";alert(S)}catch(S){console.warn("[TON Purchase] sendTransaction failed",S);const N=(S==null?void 0:S.message)||"Не удалось отправить транзакцию TON.";alert(N)}}function je(){const e=document.getElementById("exchange-modal"),t=document.getElementById("exchange-btn"),n=document.getElementById("close-exchange-btn"),a=document.getElementById("confirm-exchange-btn"),o=document.getElementById("ad-reward-btn"),i=document.getElementById("buy-ton-btn"),c=document.getElementById("from-amount"),r=document.getElementById("from-currency"),s=document.getElementById("to-amount"),d=document.getElementById("to-currency"),y=200;t&&t.addEventListener("click",()=>{e&&(e.style.display="flex")}),n&&n.addEventListener("click",()=>{e&&(e.style.display="none")});const A=()=>{const w=parseFloat((c==null?void 0:c.value)||"0")||0,x=(r==null?void 0:r.value)||"real_balance";let B=0;x==="real_balance"?(d&&(d.value="gcoin"),B=w*y):(d&&(d.value="real_balance"),B=w/y),s&&(s.value=B.toFixed(2))};if(c&&c.addEventListener("input",A),r&&r.addEventListener("change",A),a&&a.addEventListener("click",()=>{const w=parseFloat((c==null?void 0:c.value)||"0")||0,x=(r==null?void 0:r.value)||"real_balance",B=(d==null?void 0:d.value)||"gcoin",S=parseFloat((s==null?void 0:s.value)||"0")||0;if(w<=0){alert("Введите корректную сумму / Please enter a valid amount.");return}if(F.getBalance(x)<w){alert("Недостаточно средств для обмена / Insufficient funds for this exchange.");return}F.subtract(w,x),F.add(S,B),alert("Обмен выполнен! / Exchange successful!"),e&&(e.style.display="none"),c&&(c.value=""),s&&(s.value="")}),o){const w=o.innerHTML;o.addEventListener("click",async()=>{try{o.disabled=!0,o.innerHTML="Поиск рекламы… / Searching for ad…";const x=await ae.showRewardedAd();if(x&&x.ok){const B=x.provider,S=x.payload||{};let N=!1;if(B==="monetag"?N=S&&S.reward_event_type==="valued":B==="adsgram"&&(N=!!S&&S.done===!0),N){const h=Number(C.rewards.perAdUsd||.1);F.add(h,"real_balance"),alert(`Реклама просмотрена! Начислено $${h.toFixed(2)}.
Ad viewed successfully! You've earned $${h.toFixed(2)}.`)}else alert(`Реклама не была досмотрена до конца. Награда не начислена.
Ad was not completed. No reward.`)}else alert(`Ошибка рекламы, попробуйте позже.
Ad error, please try again later.`)}catch(x){console.warn("Ad error:",x),alert(`Ошибка рекламы, попробуйте позже.
Ad error, please try again later.`)}finally{o.disabled=!1,o.innerHTML=w}})}i&&i.addEventListener("click",()=>{$e()})}window.addEventListener("DOMContentLoaded",()=>{try{window.Telegram&&window.Telegram.WebApp&&typeof window.Telegram.WebApp.ready=="function"&&window.Telegram.WebApp.ready()}catch{}F.init(),le.init(),Ae(),ae.init(),je(),oe(),console.log("App initialized.")});
